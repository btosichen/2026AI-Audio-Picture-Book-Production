<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°å°å°æ¼”å¤¢å·¥å»  - è¦ªå­å½±éŸ³ç¹ªæœ¬ç‡Ÿ</title>
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Noto Sans TC -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- æ”¾å¤§æ ¸å¿ƒè¨­å®š (ç¶­æŒ 80% å¤§å°) --- */
        html {
            /* 26px * 0.8 â‰ˆ 21px */
            font-size: 21px;
        }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f0f9ff;
            touch-action: manipulation;
        }
        .animate-fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }
        .animate-bounce-slow {
            animation: bounce 3s infinite;
        }
        .animate-spin-slow {
            animation: spin 3s linear infinite;
        }
        .card-hover {
            transition: all 0.3s ease;
        }
        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        /* Custom scrollbar for cuteness */
        ::-webkit-scrollbar {
            width: 10px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1; 
        }
        ::-webkit-scrollbar-thumb {
            background: #888; 
            border-radius: 5px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555; 
        }
        @keyframes spin {
            from { transform: translateX(-50%) translateY(-50%) rotate(0deg); }
            to { transform: translateX(-50%) translateY(-50%) rotate(360deg); }
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // ------------------------------------------------------------------
        // â˜… è¨­å®šå€
        // ------------------------------------------------------------------
        // 1. Google Apps Script ç¶²å€ (ç”¨æ–¼æ¥æ”¶å­¸ç”Ÿä¸Šå‚³çš„è³‡æ–™)
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzUWs0tQ2wP4PID3Wd3lZlpihsXl9tVeRZl68KAHSLgK1taxVP_m6pAzAwYmjc0uKfs/exec"; 
        
        // 2. Google è©¦ç®—è¡¨æª¢è¦–ç¶²å€ (ç”¨æ–¼æœ€å¾Œä¸€é çµ¦è€å¸«/å­¸ç”ŸæŸ¥çœ‹å‚™ä»½)
        const GOOGLE_SHEET_VIEW_URL = "https://docs.google.com/spreadsheets/d/1yiikmJkGwRJ-_v06JG-yg9fMN-o89GaC0IDNaBOUuMg/edit?usp=sharing";

        // --- Inline Icons (Base size 32) ---
        const IconBase = ({ children, size = 32, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {children}
            </svg>
        );

        const BookOpen = (props) => ( <IconBase {...props}><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></IconBase> );
        const Music = (props) => ( <IconBase {...props}><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></IconBase> );
        const Palette = (props) => ( <IconBase {...props}><circle cx="13.5" cy="6.5" r=".5" fill="currentColor"/><circle cx="17.5" cy="10.5" r=".5" fill="currentColor"/><circle cx="8.5" cy="7.5" r=".5" fill="currentColor"/><circle cx="6.5" cy="12.5" r=".5" fill="currentColor"/><path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10c.926 0 1.648-.746 1.648-1.688 0-.437-.18-.835-.437-1.125-.29-.289-.438-.652-.438-1.125a1.64 1.64 0 0 1 1.668-1.668h1.996c3.051 0 5.555-2.503 5.555-5.554C21.965 6.012 17.461 2 12 2z"/></IconBase> );
        const Play = (props) => ( <IconBase {...props}><polygon points="5 3 19 12 5 21 5 3"/></IconBase> );
        const ChevronRight = (props) => ( <IconBase {...props}><path d="m9 18 6-6-6-6"/></IconBase> );
        const ChevronLeft = (props) => ( <IconBase {...props}><path d="m15 18-6-6 6-6"/></IconBase> );
        const CheckCircle = (props) => ( <IconBase {...props}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></IconBase> );
        const Sparkles = (props) => ( <IconBase {...props}><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L12 3Z"/></IconBase> );
        const Home = (props) => ( <IconBase {...props}><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></IconBase> );
        const Mic = (props) => ( <IconBase {...props}><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" x2="12" y1="19" y2="23"/><line x1="8" x2="16" y1="23" y2="23"/></IconBase> );
        const Clapperboard = (props) => ( <IconBase {...props}><rect width="18" height="14" x="3" y="7" rx="2" ry="2"/><path d="M7 15h10"/><path d="M7 11h2"/><path d="M13 11h4"/><path d="M3 7l2-4h14l2 4"/><path d="M7 3l2 4"/><path d="M13 3l2 4"/><path d="M13 7h-2"/></IconBase> );
        const Star = (props) => ( <IconBase {...props}><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></IconBase> );
        const UploadCloud = (props) => ( <IconBase {...props}><path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242"/><path d="M12 12v9"/><path d="m16 16-4-4-4 4"/></IconBase> );
        const Download = (props) => ( <IconBase {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></IconBase> );
        const ExternalLink = (props) => ( <IconBase {...props}><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" x2="21" y1="14" y2="3"/></IconBase> );
        const List = (props) => ( <IconBase {...props}><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></IconBase> );

        // Component: Step 1 - Introduction / Deconstruction
        const Deconstruction = ({ onNext }) => {
            const [revealed, setRevealed] = useState({ story: false, visual: false, sound: false });
            
            const handleReveal = (part) => {
                setRevealed(prev => ({ ...prev, [part]: true }));
            };

            const allRevealed = revealed.story && revealed.visual && revealed.sound;

            return (
                <div className="flex flex-col items-center justify-center space-y-12 animate-fade-in w-full">
                    <div className="text-center">
                        <h2 className="text-4xl font-bold text-blue-600 mb-4">å½±éŸ³ç¹ªæœ¬çš„ç§˜å¯†é£Ÿè­œ</h2>
                        <p className="text-gray-600 text-xl">é»æ“Šä¸‹æ–¹çš„å¯¶ç®±ï¼Œçœ‹çœ‹ä¸€æœ¬å¥½è½åˆå¥½çœ‹çš„æ›¸ç”±ä»€éº¼çµ„æˆï¼Ÿ</p>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-3 gap-8 w-full max-w-7xl px-4">
                        <div onClick={() => handleReveal('story')} className={`cursor-pointer p-8 rounded-3xl border-4 ${revealed.story ? 'bg-yellow-100 border-yellow-400' : 'bg-white border-gray-200'} card-hover flex flex-col items-center text-center h-80 justify-center`}>
                            {revealed.story ? ( <> <BookOpen size={64} className="text-yellow-600 mb-6" /> <h3 className="text-2xl font-bold text-yellow-800">1. ç²¾å½©çš„æ•…äº‹</h3> <p className="text-lg text-yellow-700 mt-4">åŠ‡æœ¬æ˜¯éˆé­‚ï¼<br/>è¦æœ‰ä¸»è§’å’Œå†’éšªã€‚</p> </> ) : ( <> <span className="text-6xl">ğŸ“</span> <p className="font-bold text-2xl text-gray-400 mt-4">é»æˆ‘è§£é–</p> </> )}
                        </div>
                        <div onClick={() => handleReveal('visual')} className={`cursor-pointer p-8 rounded-3xl border-4 ${revealed.visual ? 'bg-pink-100 border-pink-400' : 'bg-white border-gray-200'} card-hover flex flex-col items-center text-center h-80 justify-center`}>
                            {revealed.visual ? ( <> <Palette size={64} className="text-pink-600 mb-6" /> <h3 className="text-2xl font-bold text-pink-800">2. æ¼‚äº®çš„ç•«é¢</h3> <p className="text-lg text-pink-700 mt-4">æ’ç•«èˆ‡é¢¨æ ¼ï¼<br/>å¸å¼•å¤§å®¶çš„ç›®å…‰ã€‚</p> </> ) : ( <> <span className="text-6xl">ğŸ¨</span> <p className="font-bold text-2xl text-gray-400 mt-4">é»æˆ‘è§£é–</p> </> )}
                        </div>
                        <div onClick={() => handleReveal('sound')} className={`cursor-pointer p-8 rounded-3xl border-4 ${revealed.sound ? 'bg-blue-100 border-blue-400' : 'bg-white border-gray-200'} card-hover flex flex-col items-center text-center h-80 justify-center`}>
                            {revealed.sound ? ( <> <Music size={64} className="text-blue-600 mb-6" /> <h3 className="text-2xl font-bold text-blue-800">3. å‹•è½çš„è²éŸ³</h3> <p className="text-lg text-blue-700 mt-4">é…éŸ³èˆ‡éŸ³æ¨‚ï¼<br/>è®“æ•…äº‹æ´»èµ·ä¾†ã€‚</p> </> ) : ( <> <span className="text-6xl">ğŸµ</span> <p className="font-bold text-2xl text-gray-400 mt-4">é»æˆ‘è§£é–</p> </> )}
                        </div>
                    </div>

                    {allRevealed && (
                        <div className="mt-12 animate-bounce">
                            <button onClick={onNext} className="bg-green-500 hover:bg-green-600 text-white font-bold py-6 px-16 rounded-full text-2xl shadow-xl transform transition hover:scale-105 flex items-center">
                                ä¸‹ä¸€é—œï¼šä¾†å¯«æ•…äº‹å§ï¼ <ChevronRight size={32} className="ml-3" />
                            </button>
                        </div>
                    )}
                </div>
            );
        };

        // Component: Step 2 - Story Builder
        const StoryBuilder = ({ onNext, onBack, setStoryData, initialData }) => {
            const [inputs, setInputs] = useState(initialData);
            const [page, setPage] = useState(0);

            const handleChange = (e) => {
                setInputs({ ...inputs, [e.target.name]: e.target.value });
            };

            const handleFinish = () => {
                setStoryData(inputs);
                onNext();
            };

            const page0Complete = inputs.className && inputs.seatNumber && inputs.storyteller && inputs.hero;
            const page1Complete = inputs.place && inputs.item && inputs.action;

            return (
                <div className="max-w-6xl mx-auto bg-white p-12 rounded-[2.5rem] shadow-2xl w-full">
                    <div className="flex justify-between items-center mb-8">
                        <button onClick={onBack} className="text-gray-400 hover:text-gray-600 font-bold flex items-center text-xl">
                             <ChevronLeft size={28} /> è¿”å›
                        </button>
                        <h2 className="text-4xl font-bold text-center text-purple-600 flex-1">ğŸ“ æ•…äº‹è£½é€ æ©Ÿ ({page + 1}/2)</h2>
                        <div className="w-16"></div> 
                    </div>

                    {page === 0 ? (
                        <div className="space-y-8 animate-fade-in">
                            <div className="bg-purple-50 p-8 rounded-3xl border-2 border-purple-100">
                                <h3 className="font-bold text-2xl text-purple-800 mb-6 border-b-2 border-purple-200 pb-4">ğŸ§™â€â™‚ï¸ è§’è‰²è¨­å®šç¯‡</h3>
                                <div className="grid grid-cols-1 gap-6">
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                                        <div>
                                            <label className="block text-gray-700 font-bold mb-3 text-xl">1. ä½ çš„ç­ç´š</label>
                                            <select name="className" value={inputs.className} onChange={handleChange} className="w-full p-4 text-xl border-4 border-purple-200 rounded-2xl focus:border-purple-500 focus:outline-none bg-white">
                                                <option value="">è«‹é¸æ“‡ç­ç´š...</option>
                                                <option value="901">901 ç­</option>
                                                <option value="902">902 ç­</option>
                                                <option value="903">903 ç­</option>
                                                <option value="904">904 ç­</option>
                                                <option value="905">905 ç­</option>
                                                <option value="906">906 ç­</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label className="block text-gray-700 font-bold mb-3 text-xl">2. ä½ çš„åº§è™Ÿ</label>
                                            <input type="number" name="seatNumber" value={inputs.seatNumber} onChange={handleChange} className="w-full p-4 text-xl border-4 border-purple-200 rounded-2xl focus:border-purple-500 focus:outline-none bg-white" placeholder="ä¾‹ï¼š5" min="1" max="50" />
                                        </div>
                                    </div>
                                    <div>
                                        <label className="block text-gray-700 font-bold mb-3 text-xl">3. èªªæ•…äº‹çš„äºº (ä½ çš„åå­—)</label>
                                        <input type="text" name="storyteller" value={inputs.storyteller} onChange={handleChange} className="w-full p-4 text-xl border-4 border-purple-200 rounded-2xl focus:border-purple-500 focus:outline-none bg-white" placeholder="ä¾‹ï¼šç‹å°æ˜" />
                                    </div>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                                        <div>
                                            <label className="block text-gray-700 font-bold mb-3 text-xl">4. æ•…äº‹ä¸»è§’æ˜¯èª°ï¼Ÿ</label>
                                            <input type="text" name="hero" value={inputs.hero} onChange={handleChange} className="w-full p-4 text-xl border-4 border-purple-200 rounded-2xl focus:border-purple-500 focus:outline-none bg-white" placeholder="ä¾‹ï¼šå‹‡æ•¢çš„å°æé¾" />
                                        </div>
                                        <div>
                                            <label className="block text-gray-700 font-bold mb-3 text-xl">5. ä»–çš„å¥½å¤¥ä¼´ (é…è§’)ï¼Ÿ</label>
                                            <input type="text" name="sidekick" value={inputs.sidekick} onChange={handleChange} className="w-full p-4 text-xl border-4 border-purple-200 rounded-2xl focus:border-purple-500 focus:outline-none bg-white" placeholder="ä¾‹ï¼šæ„›å”±æ­Œçš„æ©Ÿå™¨äºº" />
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div className="text-right">
                                <button onClick={() => setPage(1)} disabled={!page0Complete} className={`py-4 px-12 rounded-full font-bold text-xl shadow-md transition ${page0Complete ? 'bg-purple-600 text-white hover:bg-purple-700' : 'bg-gray-200 text-gray-400'}`}>
                                    ä¸‹ä¸€é  <ChevronRight size={28} className="inline ml-1" />
                                </button>
                            </div>
                        </div>
                    ) : (
                        <div className="space-y-8 animate-fade-in">
                            <div className="bg-blue-50 p-8 rounded-3xl border-2 border-blue-100">
                                <h3 className="font-bold text-2xl text-blue-800 mb-6 border-b-2 border-blue-200 pb-4">ğŸŒ ä¸–ç•Œèˆ‡å†’éšªç¯‡</h3>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-8 mb-6">
                                    <div>
                                        <label className="block text-gray-700 font-bold mb-3 text-xl">6. åœ¨å“ªè£¡æ¢éšªï¼Ÿ</label>
                                        <input type="text" name="place" value={inputs.place} onChange={handleChange} className="w-full p-4 text-xl border-4 border-blue-200 rounded-2xl focus:border-blue-500 focus:outline-none bg-white" placeholder="ä¾‹ï¼šå……æ»¿ç³–æœçš„æ£®æ—" />
                                    </div>
                                    <div>
                                        <label className="block text-gray-700 font-bold mb-3 text-xl">7. èƒŒæ™¯æœ‰ä»€éº¼ç‰¹åˆ¥çš„ï¼Ÿ</label>
                                        <input type="text" name="setting_detail" value={inputs.setting_detail} onChange={handleChange} className="w-full p-4 text-xl border-4 border-blue-200 rounded-2xl focus:border-blue-500 focus:outline-none bg-white" placeholder="ä¾‹ï¼šå¤©ç©ºæ˜¯ç¶ è‰²çš„" />
                                    </div>
                                </div>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-8 mb-6">
                                    <div>
                                        <label className="block text-gray-700 font-bold mb-3 text-xl">8. ç™¼ç¾äº†ä»€éº¼å¯¶ç‰©ï¼Ÿ</label>
                                        <input type="text" name="item" value={inputs.item} onChange={handleChange} className="w-full p-4 text-xl border-4 border-blue-200 rounded-2xl focus:border-blue-500 focus:outline-none bg-white" placeholder="ä¾‹ï¼šç™¼å…‰çš„å¯¶çŸ³" />
                                    </div>
                                    <div>
                                        <label className="block text-gray-700 font-bold mb-3 text-xl">9. æœ€å¾Œåšäº†ä»€éº¼ï¼Ÿ</label>
                                        <input type="text" name="action" value={inputs.action} onChange={handleChange} className="w-full p-4 text-xl border-4 border-blue-200 rounded-2xl focus:border-blue-500 focus:outline-none bg-white" placeholder="ä¾‹ï¼šé–‹å¿ƒåœ°è·³èˆ" />
                                    </div>
                                </div>
                                <div>
                                    <label className="block text-gray-700 font-bold mb-3 text-xl">10. é€™å€‹æ•…äº‹çµ¦æˆ‘çš„å•Ÿç™¼ï¼Ÿ</label>
                                    <textarea name="inspiration" value={inputs.inspiration} onChange={handleChange} className="w-full p-4 text-xl border-4 border-blue-200 rounded-2xl focus:border-blue-500 focus:outline-none bg-white h-32" placeholder="ä¾‹ï¼šåªè¦å‹‡æ•¢å˜—è©¦ï¼Œå°±èƒ½ç™¼ç¾é©šå–œï¼"></textarea>
                                </div>
                            </div>
                            
                            <div className="flex justify-between items-center pt-8 border-t-2 border-gray-100">
                                <button onClick={() => setPage(0)} className="text-gray-500 font-bold px-6 py-3 hover:bg-gray-100 rounded-xl text-xl">
                                    <ChevronLeft size={28} className="inline mr-2" /> ä¸Šä¸€æ­¥
                                </button>
                                <button onClick={handleFinish} disabled={!page1Complete} className={`py-4 px-12 rounded-full text-2xl font-bold shadow-lg transform transition ${page1Complete ? 'bg-green-500 text-white hover:scale-105 hover:bg-green-600' : 'bg-gray-300 text-gray-500 cursor-not-allowed'}`}>
                                    æ•…äº‹å®Œæˆï¼å»é…éŸ³ <ChevronRight size={28} className="inline ml-2" />
                                </button>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // Component: Step 3 - Sound Studio (Formerly Step 4, now moved before Music)
        const SoundStudio = ({ onNext, onBack, storyData }) => {
            const [mood, setMood] = useState(null); 
            const [isPlaying, setIsPlaying] = useState(false);

            const playMood = (selectedMood) => {
                setMood(selectedMood);
                setIsPlaying(true);
            };

            const getMoodStyle = () => {
                switch(mood) {
                    case 'happy': return 'bg-yellow-100 border-yellow-400';
                    case 'scary': return 'bg-indigo-900 border-indigo-700 text-white';
                    case 'action': return 'bg-red-100 border-red-400';
                    default: return 'bg-gray-50 border-gray-200';
                }
            };
            
            const getMoodIcon = () => {
                switch(mood) {
                    case 'happy': return 'ğŸŒ';
                    case 'scary': return 'ğŸ‘»';
                    case 'action': return 'ğŸ”¥';
                    default: return 'ğŸµ';
                }
            };

            return (
                <div className="max-w-7xl mx-auto w-full animate-fade-in">
                    <div className="flex justify-between items-center mb-6">
                         <button onClick={onBack} className="text-gray-400 hover:text-gray-600 font-bold flex items-center text-xl">
                             <ChevronLeft size={28} /> ä¿®æ”¹æ•…äº‹
                        </button>
                    </div>
                    
                    <h2 className="text-4xl font-bold text-center text-blue-600 mb-4">ğŸ§ è²éŸ³é­”æ³•å¸« (æ°£æ°›é…å°)</h2>
                    <p className="text-center text-gray-600 mb-10 text-xl">å¹« <b>{storyData.hero}</b> çš„æ•…äº‹é¸ä¸€å€‹é©åˆçš„èƒŒæ™¯éŸ³æ¨‚æ°£æ°›å§ï¼</p>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-10 items-stretch">
                        {/* Control Panel */}
                        <div className="bg-white p-8 rounded-[2rem] shadow-lg space-y-6">
                            <h3 className="font-bold text-gray-700 mb-6 flex items-center text-2xl"><Mic size={28} className="mr-3"/> é¸æ“‡éŸ³æ¨‚æ°£æ°› (Mood)</h3>
                            <button onClick={() => playMood('happy')} className="w-full flex items-center justify-between p-6 rounded-2xl bg-yellow-50 hover:bg-yellow-100 border-2 border-yellow-200 transition"> <span className="font-bold text-yellow-800 text-xl">ğŸ˜Š è¼•é¬†æ„‰å¿«çš„éŸ³æ¨‚</span> <Play size={28} className="text-yellow-600"/> </button>
                            <button onClick={() => playMood('scary')} className="w-full flex items-center justify-between p-6 rounded-2xl bg-indigo-50 hover:bg-indigo-100 border-2 border-indigo-200 transition"> <span className="font-bold text-indigo-800 text-xl">ğŸ˜¨ ç¥ç§˜ç·Šå¼µçš„éŸ³æ¨‚</span> <Play size={28} className="text-indigo-600"/> </button>
                            <button onClick={() => playMood('action')} className="w-full flex items-center justify-between p-6 rounded-2xl bg-red-50 hover:bg-red-100 border-2 border-red-200 transition"> <span className="font-bold text-red-800 text-xl">ğŸƒ ç†±è¡€å†’éšªçš„éŸ³æ¨‚</span> <Play size={28} className="text-red-600"/> </button>
                        </div>

                        {/* Preview Screen */}
                        <div className={`p-10 rounded-[2rem] border-8 transition-all duration-500 flex flex-col items-center justify-center relative overflow-hidden ${getMoodStyle()} min-h-[400px]`}>
                            {mood && ( <div className="absolute inset-0 opacity-10 pointer-events-none flex flex-wrap content-center justify-center gap-12"> {Array(16).fill(getMoodIcon()).map((icon, i) => ( <span key={i} className="text-6xl animate-pulse">{icon}</span> ))} </div> )}
                            <div className="z-10 text-center w-full">
                                <h3 className={`text-3xl font-bold mb-6 ${mood === 'scary' ? 'text-white' : 'text-gray-800'}`}> {storyData.hero} çš„å¤§å†’éšª </h3>
                                <div className={`text-xl p-8 bg-white/80 backdrop-blur-sm rounded-3xl shadow-sm ${mood === 'scary' ? 'text-gray-900' : 'text-gray-800'} text-left leading-relaxed`}>
                                    <p className="text-lg text-gray-500 mb-3 font-bold">ä½œè€…ï¼š{storyData.storyteller}</p>
                                    <p>
                                        å¾ˆä¹…ä»¥å‰ï¼Œ<b>{storyData.hero}</b> å’Œå¥½æœ‹å‹ <b>{storyData.sidekick || 'ç¥ç¥•äºº'}</b> 
                                        ä¾†åˆ° <b>{storyData.place}</b>ã€‚
                                        é€™è£¡ <b>{storyData.setting_detail}</b>ï¼Œéå¸¸ç‰¹åˆ¥ã€‚
                                        <br/><br/>
                                        çªç„¶ï¼ä»–å€‘ç™¼ç¾äº† <b>{storyData.item}</b>ï¼
                                        æ–¼æ˜¯ä»–èˆˆå¥®åœ° <b>{storyData.action}</b>ï¼
                                    </p>
                                </div>
                                <div className="mt-8">
                                    <span className={`inline-block px-6 py-3 rounded-full text-lg font-bold ${ mood === 'happy' ? 'bg-yellow-200 text-yellow-800' : mood === 'scary' ? 'bg-indigo-700 text-indigo-100' : mood === 'action' ? 'bg-red-200 text-red-800' : 'bg-gray-200 text-gray-600' }`}> {mood ? `æ­£åœ¨æ’­æ”¾ï¼š${mood === 'happy' ? 'å¿«æ¨‚' : mood === 'scary' ? 'æ‡¸ç–‘' : 'ç†±è¡€'}æ°›åœ` : 'è«‹é¸æ“‡éŸ³æ¨‚...'} </span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div className="mt-12 text-center">
                        <button disabled={!mood} onClick={() => onNext(mood)} className={`py-6 px-16 rounded-full text-2xl font-bold shadow-lg transform transition ${mood ? 'bg-blue-600 text-white hover:scale-105 hover:bg-blue-700' : 'bg-gray-300 text-gray-500 cursor-not-allowed'}`}>
                            ä¸‹ä¸€æ­¥ï¼šæŒ‘æˆ°é€²éšéŸ³æ¨‚ <ChevronRight size={28} className="inline ml-2" />
                        </button>
                    </div>
                </div>
            );
        };

        // Component: Step 4 - Music Creation (Formerly Step 3, now moved to the end)
        const MusicCreation = ({ onNext, onBack }) => {
            return (
                <div className="max-w-7xl mx-auto w-full animate-fade-in">
                     <div className="flex justify-between items-center mb-6">
                         <button onClick={onBack} className="text-gray-400 hover:text-gray-600 font-bold flex items-center text-xl">
                             <ChevronLeft size={28} /> å›åˆ°æ°£æ°›é¸æ“‡
                        </button>
                    </div>
                    
                    <h2 className="text-4xl font-bold text-center text-yellow-600 mb-4">ğŸµ éŸ³æ¨‚å‰µä½œå¯¦é©—å®¤</h2>
                    <p className="text-center text-gray-600 mb-10 text-xl">æœ€å¾ŒæŒ‘æˆ°ï¼šä½¿ç”¨ç¥å¥‡çš„ AI å·¥å…·ï¼Œç‚ºä½ çš„æ•…äº‹é‡èº«æ‰“é€ ä¸€é¦–å°ˆå±¬ä¸»é¡Œæ›²ï¼</p>

                    <div className="bg-white p-6 rounded-[2rem] shadow-xl border-4 border-yellow-200 mb-10">
                         <div className="flex justify-between items-center mb-4 px-2">
                             <h3 className="font-bold text-2xl text-yellow-800 flex items-center">
                                <Sparkles size={32} className="mr-2 text-yellow-500" /> 
                                ç¹ªæœ¬éŸ³æ¨‚é­”æ³•å¸«æ•™å­¸
                             </h3>
                             <a href="https://btosichen.github.io/2026SunoMusicBook/" target="_blank" className="text-blue-600 font-bold hover:text-blue-800 flex items-center bg-blue-50 px-4 py-2 rounded-lg transition hover:bg-blue-100">
                                <ExternalLink size={24} className="mr-2" /> åœ¨æ–°è¦–çª—é–‹å•Ÿ
                             </a>
                         </div>
                         <div className="w-full h-[600px] bg-gray-100 rounded-xl overflow-hidden relative border border-gray-200">
                             <iframe 
                                src="https://btosichen.github.io/2026SunoMusicBook/" 
                                className="w-full h-full border-0"
                                title="Suno Music Book Tutorial"
                             ></iframe>
                         </div>
                    </div>

                    <div className="text-center">
                        <button onClick={onNext} className="bg-green-500 hover:bg-green-600 text-white font-bold py-6 px-16 rounded-full text-2xl shadow-lg transform transition hover:scale-105 flex items-center mx-auto">
                            å®Œæˆå‰µä½œï¼Œçœ‹æˆæœï¼ <CheckCircle size={28} className="ml-3" />
                        </button>
                    </div>
                </div>
            )
        };

        // Component: Step 5 - Conclusion & Export
        const Conclusion = ({ onReset, onBack, storyData, mood }) => {
            const [uploading, setUploading] = useState(false);
            const [uploadStatus, setUploadStatus] = useState(null);

            const downloadCSV = () => {
                const headers = ["Date", "ClassName", "SeatNumber", "Storyteller", "Hero", "Sidekick", "Place", "SettingDetail", "Item", "Action", "Inspiration", "Mood"];
                const values = [
                    new Date().toLocaleString(), storyData.className, storyData.seatNumber, storyData.storyteller, storyData.hero, storyData.sidekick, storyData.place, storyData.setting_detail, storyData.item, storyData.action, storyData.inspiration, mood
                ];
                const csvRow = values.map(v => `"${String(v || '').replace(/"/g, '""')}"`).join(",");
                const csvContent = "\uFEFF" + headers.join(",") + "\n" + csvRow; 
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement("a");
                link.setAttribute("href", url);
                link.setAttribute("download", `${storyData.storyteller}_çš„æ•…äº‹.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            const uploadToGoogle = async () => {
                if (!GOOGLE_SCRIPT_URL) {
                    alert("è«‹è¨­å®š GOOGLE_SCRIPT_URL");
                    return;
                }
                setUploading(true);
                setUploadStatus(null);
                const data = { ...storyData, mood: mood, date: new Date().toLocaleString() };

                try {
                    await fetch(GOOGLE_SCRIPT_URL, {
                        method: 'POST',
                        mode: 'no-cors', 
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                    setUploadStatus('success');
                } catch (error) {
                    console.error("Upload error:", error);
                    setUploadStatus('error');
                } finally {
                    setUploading(false);
                }
            };

            return (
                <div className="flex flex-col items-center justify-center animate-fade-in max-w-7xl mx-auto text-center w-full relative">
                    {/* Back Button */}
                    <button onClick={onBack} className="absolute top-0 left-0 text-gray-400 hover:text-gray-600 font-bold flex items-center text-xl">
                         <ChevronLeft size={28} /> è¿”å›éŸ³æ¨‚å‰µä½œ
                    </button>

                    <div className="mb-8 mt-12 relative">
                        <Star size={160} className="text-yellow-400 absolute top-0 left-1/2 transform -translate-x-1/2 -translate-y-1/2 animate-spin-slow" />
                        <Clapperboard size={192} className="text-gray-800 relative z-10" />
                    </div>
                    
                    <h2 className="text-5xl font-bold text-gray-800 mb-6">æ­å–œï¼ä½ æ˜¯å°å°å°æ¼”äº†ï¼</h2>
                    <p className="text-2xl text-gray-600 mb-10">
                        ç­ç´šåº§è™Ÿï¼š<span className="text-blue-600 font-bold">{storyData.className} ç­ {storyData.seatNumber} è™Ÿ</span><br/>
                        æ•…äº‹ä½œè€…ï¼š<span className="text-blue-600 font-bold">{storyData.storyteller}</span><br/>
                        ä½ çš„ä½œå“å·²ç¶“å®Œæˆå›‰ï¼
                    </p>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-8 w-full max-w-4xl mb-16 mx-auto">
                        <button onClick={downloadCSV} className="flex flex-col items-center justify-center p-10 bg-white border-4 border-green-200 rounded-[2rem] hover:bg-green-50 hover:border-green-400 transition shadow-md group">
                            <Download size={64} className="text-green-600 mb-4 group-hover:scale-110 transition" />
                            <span className="font-bold text-2xl text-green-800">ä¸‹è¼‰æª”æ¡ˆ (CSV)</span>
                            <span className="text-lg text-green-600 mt-2">å­˜åˆ°é€™å°é›»è…¦å‚™ä»½</span>
                        </button>

                        <button onClick={uploadToGoogle} disabled={uploading || uploadStatus === 'success'} className={`flex flex-col items-center justify-center p-10 border-4 rounded-[2rem] transition shadow-md group ${uploadStatus === 'success' ? 'bg-blue-100 border-blue-400' : 'bg-white border-blue-200 hover:bg-blue-50 hover:border-blue-400'}`}>
                            {uploadStatus === 'success' ? <CheckCircle size={64} className="text-blue-600 mb-4"/> : <UploadCloud size={64} className={`text-blue-600 mb-4 ${uploading ? 'animate-bounce' : 'group-hover:scale-110 transition'}`} />}
                            <span className="font-bold text-2xl text-blue-800">
                                {uploading ? 'ä¸Šå‚³ä¸­...' : uploadStatus === 'success' ? 'ä¸Šå‚³æˆåŠŸï¼' : 'ä¸Šå‚³åˆ°é›²ç«¯'}
                            </span>
                            <span className="text-lg text-blue-600 mt-2">å‚³çµ¦è€å¸«çš„è©¦ç®—è¡¨</span>
                        </button>
                    </div>

                    <div className="w-full text-left mb-12">
                        <h3 className="font-bold text-4xl text-center text-purple-600 mb-10 border-b-2 border-purple-200 pb-4 inline-block w-full">âœ¨ æ¥ä¸‹ä¾†ï¼šAI é­”æ³•å»¶ä¼¸æ•™å­¸ âœ¨</h3>
                        <div className="grid grid-cols-1 gap-8">
                            <div className="bg-white p-8 rounded-[2rem] shadow-lg border-l-8 border-purple-400 hover:shadow-xl transition">
                                <h4 className="flex items-center text-2xl font-bold text-purple-700 mb-4">
                                    <span className="bg-purple-100 p-2 rounded-lg mr-3">1</span> ä½¿ç”¨ AI è®“æ•…äº‹æ›´å…·é«”
                                </h4>
                                <p className="text-gray-600 mb-4 text-lg">åœ¨ç¶²é å¡«å¯«çš„æ•…äº‹åªæ˜¯å¤§ç¶±ï¼Œè®“ AI å¹«ä½ è®Šæˆ 300 å­—çš„æº«é¦¨æ•…äº‹å§ï¼</p>
                                <div className="bg-gray-50 p-4 rounded-xl border border-gray-200 mb-4">
                                    <p className="font-bold text-gray-700 mb-2">ğŸ¤– æ¨è–¦å·¥å…·ï¼š<a href="https://chatgpt.com/" target="_blank" className="text-blue-600 underline hover:text-blue-800">ChatGPT</a> æˆ– Google Gemini</p>
                                </div>
                            </div>

                            <div className="bg-white p-8 rounded-[2rem] shadow-lg border-l-8 border-pink-400 hover:shadow-xl transition">
                                <h4 className="flex items-center text-2xl font-bold text-pink-700 mb-4">
                                    <span className="bg-pink-100 p-2 rounded-lg mr-3">2</span> ä½¿ç”¨ AI ç•«å‡ºæ¯ä¸€é 
                                </h4>
                                <p className="text-gray-600 mb-4 text-lg">æŠŠæ–‡å­—è®ŠæˆçœŸçš„ç¹ªæœ¬ç•«é¢ã€‚</p>
                                <div className="bg-gray-50 p-4 rounded-xl border border-gray-200 mb-4">
                                    <p className="font-bold text-gray-700 mb-2">ğŸ¨ æ¨è–¦å·¥å…·ï¼š<a href="https://www.bing.com/images/create" target="_blank" className="text-blue-600 underline hover:text-blue-800">Bing Image Creator</a></p>
                                </div>
                            </div>

                            <div className="bg-white p-8 rounded-[2rem] shadow-lg border-l-8 border-blue-400 hover:shadow-xl transition">
                                <h4 className="flex items-center text-2xl font-bold text-blue-700 mb-4">
                                    <span className="bg-blue-100 p-2 rounded-lg mr-3">3</span> è£½ä½œæˆæœ‰è²ç¹ªæœ¬
                                </h4>
                                <p className="text-gray-600 mb-4 text-lg">çµåˆè²éŸ³èˆ‡ç•«é¢ï¼Œè®ŠæˆçœŸæ­£çš„å½±ç‰‡ï¼</p>
                                <div className="bg-gray-50 p-4 rounded-xl border border-gray-200 mb-4">
                                    <p className="font-bold text-gray-700 mb-2">ğŸ¬ å‰ªè¼¯è»Ÿé«”ï¼šCanva</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div className="mb-12 border-t-2 border-gray-200 pt-8 w-full">
                         <div className="flex justify-between items-center bg-gray-50 p-6 rounded-2xl border border-gray-200">
                             <div>
                                <h3 className="font-bold text-2xl text-gray-800 flex items-center">
                                    <List size={28} className="mr-3 text-gray-600" />
                                    è€å¸«å°ˆå€ / æˆæœæª¢è¦–
                                </h3>
                                <p className="text-gray-500 mt-1">æŸ¥çœ‹æ‰€æœ‰å­¸ç”Ÿçš„ä¸Šå‚³ç´€éŒ„èˆ‡ä½œå“</p>
                             </div>
                             <a href={GOOGLE_SHEET_VIEW_URL} target="_blank" className="bg-gray-800 hover:bg-black text-white font-bold py-4 px-8 rounded-xl text-xl shadow-md transform transition hover:scale-105 flex items-center">
                                é–‹å•Ÿ Google è©¦ç®—è¡¨ <ExternalLink size={24} className="ml-2" />
                             </a>
                         </div>
                    </div>

                    <button onClick={onReset} className="bg-gray-800 hover:bg-black text-white font-bold py-6 px-16 rounded-full text-2xl shadow-xl transform transition hover:scale-105 flex items-center mb-12">
                        <Home size={32} className="mr-3" /> å†ç©ä¸€æ¬¡
                    </button>
                </div>
            );
        };

        // Main App Component
        const App = () => {
            const [step, setStep] = useState(0); 
            // 0:Intro, 1:Deconstruction, 2:Story, 3:Sound, 4:Music(New), 5:Conclusion
            const [storyData, setStoryData] = useState({ className: '', seatNumber: '', storyteller: '', hero: '', sidekick: '', place: '', setting_detail: '', item: '', action: '', inspiration: '' });
            const [finalMood, setFinalMood] = useState('');

            const nextStep = () => setStep(s => s + 1);
            const prevStep = () => setStep(s => s - 1);
            
            const goToConclusion = (mood) => {
                setFinalMood(mood);
                setStep(4); // Next is Music Creation
            };

            const resetApp = () => {
                setStep(0);
                setStoryData({ className: '', seatNumber: '', storyteller: '', hero: '', sidekick: '', place: '', setting_detail: '', item: '', action: '', inspiration: '' });
                setFinalMood('');
            };

            const renderStep = () => {
                switch(step) {
                    case 0:
                        return (
                            <div className="flex flex-col items-center justify-center h-full text-center space-y-12 animate-fade-in py-16">
                                <div className="bg-white p-8 rounded-full shadow-2xl mb-6"> <span className="text-8xl">ğŸ¥</span> </div>
                                <h1 className="text-7xl font-bold text-gray-800 tracking-tight"> å°å°å°æ¼”<span className="text-blue-500">å¤¢å·¥å» </span> </h1>
                                <p className="text-3xl text-gray-600 max-w-4xl leading-relaxed"> æ­¡è¿ä¾†åˆ°è¦ªå­å½±éŸ³ç¹ªæœ¬ç‡Ÿï¼<br/> æº–å‚™å¥½å‰µä½œå±¬æ–¼ä½ çš„ç¬¬ä¸€å€‹å‹•æ…‹æ•…äº‹äº†å—ï¼Ÿ </p>
                                <button onClick={nextStep} className="bg-blue-600 hover:bg-blue-700 text-white font-bold py-8 px-20 rounded-full text-4xl shadow-2xl transform transition hover:scale-110 flex items-center"> é–‹å§‹å†’éšª <Sparkles size={40} className="ml-4" /> </button>
                            </div>
                        );
                    case 1: return <Deconstruction onNext={nextStep} />;
                    case 2: return <StoryBuilder onNext={nextStep} onBack={prevStep} setStoryData={setStoryData} initialData={storyData} />;
                    case 3: return <SoundStudio onNext={nextStep} onBack={prevStep} storyData={storyData} />;
                    case 4: return <MusicCreation onNext={nextStep} onBack={prevStep} />;
                    case 5: return <Conclusion onReset={resetApp} onBack={prevStep} storyData={storyData} mood={finalMood} />;
                    default: return <div>Error</div>;
                }
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-blue-50 to-purple-50 flex flex-col">
                    <header className="bg-white/80 backdrop-blur-md sticky top-0 z-50 border-b border-gray-200">
                        <div className="max-w-7xl mx-auto px-6 h-24 flex items-center justify-between">
                            <div className="flex items-center space-x-4 font-bold text-3xl text-gray-800">
                                <Clapperboard size={40} className="text-blue-600" /> <span>DirectorStudio</span>
                            </div>
                            <div className="flex space-x-4"> {[0, 1, 2, 3, 4, 5].map(i => ( <div key={i} className={`h-3 w-12 rounded-full transition-all duration-300 ${step >= i ? 'bg-blue-500' : 'bg-gray-200'}`} /> ))} </div>
                        </div>
                    </header>
                    <main className="flex-grow container mx-auto px-6 py-12 flex flex-col justify-center"> {renderStep()} </main>
                    <footer className="text-center py-8 text-gray-400 text-xl">
                        <div>&copy; 2026 è¦ªå­å½±éŸ³ç¹ªæœ¬ç‡ŸéšŠæ•™æ | Designed for Kids & Parents</div>
                        <div className="mt-2 text-lg">è‡ºåŒ—å¸‚ç«‹é™½æ˜é«˜ä¸­åœ‹ä¸­éƒ¨ é™³æ”¿å·è€å¸«è¨­è¨ˆ</div>
                    </footer>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
